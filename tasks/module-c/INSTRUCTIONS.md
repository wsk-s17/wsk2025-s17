# Module C - REST API

Вам необходимо разработать REST API для сервиса объявлений - гик-барахолка. Это платформа, где пользователи могут размещать и просматривать объявления о продаже конструкторов лего, настольных игр, книг, сувениров и т.д.

В данном модуле нужно будет реализовать разделение по ролям: автор объявления, гость, модератор.

## Competitor Information

Дамп базы данных не предоставляется, вам необходимо создать структуру и наполнить таблицы.

Все эндпоинты и правила валидации описаны в файле (`media-files/swagger/openapi.yaml`).

Создайте следующие аккаунты и включите в дамп:
- Ethan Brooks, +1 202 555 0143, ethan@ws-s17.kz, <hash(ethan_123)>, user
- Olivia Carter, +44 7700 900321, olivia@ws-s17.kz, <hash(olivia_123)>, moderator

## Database

В папке `database` проекта сохраните дамп базы данных (`DB_DUMP.sql`) и ER диаграмму (`ERD.png`).

В дампе базы данных добавьте тестовые данные для всех таблиц, чтобы авто-тесты прошли успешно.

## General rules for the API

* Порядок свойств в объектах не имеет значения.
* Заголовок `Content-Type` ответа всегда имеет значение `application/json`, если не указано иное.
* Токен для защищенных конечных точек должен быть указан как токен **Bearer** в заголовке **Authorization**.
* Временные метки форматируются как строки ISO-8601. Например, 2032-01-31T21:59:35.000Z. В некоторых местах указан нужный формат.

### Categories

| Поле  | Тип и ограничения                                |
|-------|--------------------------------------------------|
| `id`  | Primary Key                                      |
| `name`| Уникальное название, максимум 100 символов       |

### Users

| Поле        | Тип и ограничения                                 |
|-------------|---------------------------------------------------|
| `id`        | Primary Key                                       |
| `name`      | Опциональное имя, максимум 100 символов           |
| `phone`     | Уникальный номер телефона                         |
| `email`     | Уникальный адрес электронной почты                |
| `password`  | Пароль (хэш)                                      |
| `role`      | Enum: `user`, `moderator`<br>По умолчанию: `user` |
| `created_at`| Дата и время создания                             |
| `updated_at`| Дата и время обновления                           |

### Adverts

| Поле          | Тип и ограничения                                                                         |
|---------------|-------------------------------------------------------------------------------------------|
| `id`          | Primary Key                                                                               |
| `status`      | Enum: `draft`, `moderation`, `declined`, `published`, `archived`<br>По умолчанию: `draft` |
| `title`       | Строка, максимум 200 символов                                                             |
| `text`        | Строка, максимум 1000 символов                                                            |
| `price`       | Цена                                                                                      |
| `category_id` | Внешний ключ на категорию                                                                 |
| `user_id`     | Внешний ключ на пользователя                                                              |
| `photos`      | JSON-массив ссылок на загруженные фото                                                    |
| `created_at`  | Дата и время создания                                                                     |
| `updated_at`  | Дата и время обновления                                                                   |

### Views

| Поле         | Описание     |
|--------------|--------------|
| `advert_id`  | Объявление   |
| `user_id`    | Пользователь |
| `created_at` |              |
| `updated_at` |              |

## REST API Requirements

### Auth

- При регистрации пользователь указывает номер телефона и email.
- Вход возможен по номеру телефона или email.
- Пароль хранится в хэшированном виде.
- Для авторизации используется токен, который состоит минимум из 32 символов.
- Пользователь может получить и обновить свой профиль.
- Пользователь может получить список своих объявлений с фильтром по статусу.

### Categories

- Получение списка категорий не требует авторизации.

### Adverts

- Получение списка объявлений и деталей не требует авторизации.
- Запрос за списком объявлений содержит фильтры по категории, диапазону цен и текстовый поиск. Фильтр по тексту должен искать по заголовку, тексту объявления, названию категории и имени пользователя-автора.
- Список объявлений можно сортировать по дате или цене в возрастающем или убывающем порядке.
- Сортировка должна учитывать услугу VIP, о ней далее.

- При запросе за деталями объявления авторизованным пользователем с ролью `user` создается запись в таблице `views`. При повторном запросе новая запись не создается, а обновляется значение `updated_at`.
- Авторизованный пользователь может создать объявление — оно создается в статусе `draft`. Должен содержать минимум одну фотографию.
- Пользователь может редактировать свои объявления только в статусе `draft`.
- Модератор может редактировать любое объявление.
- Удалить объявление может только автор в статусе `draft` или `archived`.

Переходы между статусами:
- Пользователь:
  - `draft` → `moderation`
  - `published` → `draft`
  - `declined` → `draft`
  - `published` → `archived`
  - `draft` → `archived`
  - `declined` → `archived`
- Модератор:
  - `moderation` → `published`
  - `moderation` → `declined`
  - `published` → `declined`

### Advantage Services

В стандартной поисковой выдаче объявления фильтруются по категорию и тексту и сортируются по дате/цене. Но у пользователей должна быть возможность продвинуть объявление выше в поиске. Для этого можно подключить услугу VIP или TOP.

Услуга VIP подключается к одному объявлению на 7 дней и дает следующие возможности:
- Если выбрана любая сортировка, на первые 3 позиции в выдаче попадают случайные 3 VIP-объявления. При этом они не должны повторяться в последующих позициях.
- Если выбран фильтр по тексту, то в выдачу все равно попадают VIP-объявления, где **нет** совпадения по фильтру текста
- Если выбран фильтр по цене, то в выдачу все равно попадают VIP-объявления, где цена не попадает в выбранный диапазон на менее чем 100. Например, в фильтры выбрано "до 1200" и в выдаче окажется VIP-объявление за 1290.

Услуга TOP подключается к одному объявлению на 3 дня и дает следующие возможности:
- Если выбрана любая сортировка, на первой позиции в выдаче закреплено TOP-объявление (перед блоком VIP). При этом оно не должны повторяться в последующих позициях.
- В отличие от VIP, к TOP объявлению применяются фильтры по общим правилам. Если в выдачу попадает более 1 TOP объявления, они находятся на первых позициях и между собой сортируются по времени подключения услуги (сначала недавно подключенные).
  
Ваша задача создать таблицу для хранения информации о подключенных услугах, структура на ваше усмотрение, но будет оцениваться нормализация.

Эндпоинт для подключения, продления услуги и получения услуг также необходимо спроектировать самостоятельно и дополнить файл **openapi.yaml**. Сохранить его в папке `swagger` проекта.

Оформите README.md файл, чтобы мы смогли разобраться в вашем проекте с новыми эндпоинтами.